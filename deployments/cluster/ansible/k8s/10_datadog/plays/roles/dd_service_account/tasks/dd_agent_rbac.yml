- name: "Delete previous deployments if exists"
  become: true
  become_user: "{{ K8S_ADMIN }}"
  shell: |
    {{ CTL }} delete -f {{ role_path|basename }}/dd-agent-rbac.yaml
  args:
    chdir: "{{ DATADOG_MANIFEST_HOME }}"
  ignore_errors: true
  run_once: true

#--------------------------------------------------------------------------------
# datadog RBAC for {{ DATADOG_SERVICE_ACCOUNT }}
#--------------------------------------------------------------------------------
- name: "mkdir {{ DATADOG_MANIFEST_HOME }}/{{ role_path|basename }} if not exist"
  file:
    path:   "{{ DATADOG_MANIFEST_HOME }}/{{ role_path|basename }}"
    state:  "absent"
    owner:  "dd-agent"
    group:  "dd-agent"
    mode:   0770
  run_once: true
- file:
    path:   "{{ DATADOG_MANIFEST_HOME }}/{{ role_path|basename }}"
    state:  "directory"
    owner:  "dd-agent"
    group:  "dd-agent"
    mode:   0770
  run_once: true

- name: "Place {{ DATADOG_SERVICE_ACCOUNT }} service account manifest"
  template:
    src:    "{{ role_path }}/templates/dd-agent-rbac.yaml"
    dest:   "{{ DATADOG_MANIFEST_HOME }}/{{ role_path|basename }}/dd-agent-rbac.yaml"
    owner:  "dd-agent"
    group:  "dd-agent"
    mode:   0640
  run_once: true

- name: "Deploy RBAC for {{ DATADOG_SERVICE_ACCOUNT }}"
  become: true
  become_user: "{{ K8S_ADMIN }}"
  shell: |
     {{ CTL }} apply -f {{ role_path|basename }}/dd-agent-rbac.yaml
  args:
    chdir: "{{ DATADOG_MANIFEST_HOME }}"
  run_once: true