#--------------------------------------------------------------------------------
# Datadog installation.
# Make dd-agent can access K8S certificate files for client auth, etc.
#--------------------------------------------------------------------------------
- include: "{{ ansible_distribution }}_{{ ansible_distribution_major_version}}.yml"
- name: "dd-agent in {{ K8S_GROUP }} to access K8S file e.g certificates"
  user:
    name:     "dd-agent"
    groups:   "{{ K8S_GROUP }}"
    append:   "yes"                 # useradd -aG

#--------------------------------------------------------------------------------
# Make sure dd-agent user can access K8S client certificates for K8S checks.
# This has been done in K8S installation module but to be sure.
#--------------------------------------------------------------------------------
- name: "Give rx access to {{ K8S_CA_HOME }} for {{ K8S_GROUP }}"
  file:
    path:     "{{ K8S_CA_HOME }}"
    state:    "directory"
    group:    "{{ K8S_GROUP }}"
    mode:     0750
    recurse:  yes

- name: "Give r access to client certificate files for {{ K8S_GROUP }}"
  file:
    path:     "{{ item }}"
    state:    "file"
    group:    "{{ K8S_GROUP }}"
    mode:     0640
  with_items:
    - "{{ APISERVER_CLIENT_CRT }}"
    - "{{ APISERVER_CLIENT_KEY }}"
    - "{{ APISERVER_CA_CRT }}"
    - "{{ KUBELET_CLIENT_CRT }}"
    - "{{ KUBELET_CLIENT_KEY }}"
    - "{{ KUBELET_CA_CRT }}"
    - "{{ ETCD_CLIENT_CRT }}"
    - "{{ ETCD_CLIENT_KEY }}"
    - "{{ ETCD_CA_CRT }}"
